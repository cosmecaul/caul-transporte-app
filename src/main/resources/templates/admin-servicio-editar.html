<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${pageTitle} ?: 'Editar servicio'">Editar servicio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SortableJS para drag & drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        .campo-error {
            border-color: rgb(248 113 113) !important;   /* red-400 */
            background-color: rgb(254 242 242) !important; /* red-50 */
        }
    </style>
</head>
<body class="min-h-screen bg-slate-100">

<div class="min-h-screen flex">

    <!-- SIDEBAR -->
    <aside class="hidden md:flex md:flex-col w-64 bg-slate-900 text-slate-100">
        <div class="px-6 py-4 border-b border-slate-800 flex items-center gap-3">
            <div class="w-9 h-9 rounded-2xl bg-slate-100 text-slate-900 flex items-center justify-center text-lg font-bold">
                T
            </div>
            <div>
                <div class="text-sm font-semibold">Transporte CAUL</div>
                <div class="text-xs text-slate-400">Panel de administraci√≥n</div>
            </div>
        </div>

        <nav class="flex-1 px-3 py-4 text-sm space-y-1">
            <a th:href="@{/admin/dashboard}"
               class="flex items-center gap-2 px-3 py-2 rounded-xl hover:bg-slate-800">
                <span>üìä</span>
                <span>P√°gina principal</span>
            </a>

            <div class="mt-2 mb-1 text-[11px] uppercase tracking-wide text-slate-500 px-3">Maestros</div>

            <a th:href="@{/admin/conductores}" class="flex items-center gap-2 px-3 py-2 rounded-xl hover:bg-slate-800">
                <span>üöó</span><span>Conductores</span>
            </a>
            <a th:href="@{/admin/vehiculos}" class="flex items-center gap-2 px-3 py-2 rounded-xl hover:bg-slate-800">
                <span>üöô</span><span>Veh√≠culos</span>
            </a>
            <a th:href="@{/admin/clientes}" class="flex items-center gap-2 px-3 py-2 rounded-xl hover:bg-slate-800">
                <span>üë•</span><span>Clientes</span>
            </a>
            <a th:href="@{/admin/rutas}" class="flex items-center gap-2 px-3 py-2 rounded-xl hover:bg-slate-800">
                <span>üß≠</span><span>Rutas</span>
            </a>

            <div class="mt-3 mb-1 text-[11px] uppercase tracking-wide text-slate-500 px-3">Operaci√≥n</div>

            <a th:href="@{/aplicacion/servicios}"
               class="flex items-center gap-2 px-3 py-2 rounded-xl hover:bg-slate-800">
                <span>üßæ</span>
                <span>Servicios (hoy)</span>
            </a>
        </nav>

        <div class="px-4 py-3 border-t border-slate-800 text-xs text-slate-400">
            ¬© <span id="yearSpanSidebar"></span> Transporte CAUL
        </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 flex flex-col min-w-0">

        <!-- Barra superior -->
        <header class="w-full bg-white border-b border-slate-200 px-4 md:px-6 py-3 flex 
                       items-center justify-between flex-wrap gap-3">
            <div class="flex items-center gap-3">
                <button class="md:hidden inline-flex items-center justify-center w-9 h-9 
                               rounded-xl bg-slate-900 text-white">T</button>

                <div>
                    <h1 class="text-lg md:text-2xl font-semibold text-slate-900">
                        Editar servicio
                    </h1>
                    <p class="text-xs md:text-sm text-slate-500">
                        Modifica datos del servicio y su lista de pasajeros.
                    </p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div class="hidden sm:flex flex-col text-right">
                    <span class="text-xs text-slate-400">Usuario</span>
                    <span class="text-xs md:text-sm font-medium text-slate-700">admin</span>
                </div>

                <a th:href="@{/logout}"
                   class="text-xs md:text-sm font-medium px-3 py-1.5 rounded-full 
                          border border-slate-300 hover:bg-slate-100">
                    Cerrar sesi√≥n
                </a>

                <a th:href="@{/admin/dashboard}"
                   class="text-xs px-3 py-1.5 rounded-full border border-slate-300 text-slate-700 hover:bg-slate-50">
                    ‚Üê Volver al dashboard
                </a>
            </div>
        </header>

        <!-- CONTENIDO -->
        <div class="flex-1 px-4 md:px-6 py-4 md:py-6 space-y-6 overflow-y-auto">

            <!-- Mensajes flash -->
            <div th:if="${messageSuccess}" class="px-4 py-2 rounded-xl bg-emerald-50 border border-emerald-200 text-emerald-800 text-xs">
                <span th:text="${messageSuccess}"></span>
            </div>
            <div th:if="${messageError}" class="px-4 py-2 rounded-xl bg-rose-50 border border-rose-200 text-rose-800 text-xs">
                <span th:text="${messageError}"></span>
            </div>

            <!-- FORMULARIO PRINCIPAL -->
            <!-- Usamos *{id} en el action, as√≠ no dependemos de un modelo extra "id" -->
			<form th:object="${form}"
						      th:action="@{/admin/servicios/{id}/editar(id=${id})}"
						      method="post"
						      class="space-y-4">

                <!-- Errores generales de validaci√≥n -->
                <div th:if="${#fields.hasErrors()}"
                     class="px-4 py-3 rounded-xl bg-rose-50 border border-rose-200 text-rose-800 text-xs">
                    <p class="font-semibold mb-1">Hay errores en el formulario:</p>
                    <ul class="list-disc list-inside space-y-0.5">
                        <li th:each="err : ${#fields.errors('*')}"
                            th:text="${err}">Error</li>
                    </ul>
                </div>

                <!-- Card: datos base del servicio -->
                <section class="bg-white rounded-2xl border border-slate-100 p-4 shadow-sm space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-sm font-semibold text-slate-900">Datos del servicio</h2>
                            <p class="text-xs text-slate-500">Cliente, veh√≠culo, horarios y trayecto.</p>
                        </div>
                        <div class="flex items-center">
                            <span class="text-xs text-gray-500 mr-1">ID servicio:</span>
							<span class="text-xs text-gray-500 mr-1" th:text="${id}">0</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                        <!-- Fecha -->
                        <label class="flex flex-col gap-1">
                            <span class="font-medium text-slate-600 text-[11px]">Fecha</span>
                            <input type="date" th:field="*{fecha}"
                                   class="px-3 py-1.5 rounded-xl border border-slate-200 text-slate-700" />
                        </label>

                        <!-- Cliente -->
                        <label class="flex flex-col gap-1">
                            <span class="font-medium text-slate-600 text-[11px]">Cliente</span>
                            <select th:field="*{clienteId}"
                                    class="px-3 py-1.5 rounded-xl border border-slate-200 text-slate-700">
                                <option value="">Seleccione...</option>
                                <option th:each="c : ${clientes}"
                                        th:value="${c.id}"
                                        th:text="${c.razonSocial}">Cliente</option>
                            </select>
                        </label>

                        <!-- Estado -->
                        <label class="flex flex-col gap-1">
                            <span class="font-medium text-slate-600 text-[11px]">Estado</span>
                            <select th:field="*{estado}"
                                    class="px-3 py-1.5 rounded-xl border border-slate-200 text-slate-700">
                                <option value="PROGRAMADO">PROGRAMADO</option>
                                <option value="EN_CURSO">EN_CURSO</option>
                                <option value="FINALIZADO">FINALIZADO</option>
                                <option value="CANCELADO">CANCELADO</option>
                                <option value="NO_REALIZADO">NO_REALIZADO</option>
                            </select>
                        </label>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                        <!-- Veh√≠culo -->
                        <label class="flex flex-col gap-1">
                            <span class="font-medium text-slate-600 text-[11px]">Veh√≠culo</span>
                            <select th:field="*{vehiculoId}"
                                    class="px-3 py-1.5 rounded-xl border border-slate-200 text-slate-700">
                                <option value="">Seleccione...</option>
                                <option th:each="v : ${vehiculos}"
                                        th:value="${v.id}"
                                        th:text="${v.patente}">Veh√≠culo</option>
                            </select>
                        </label>

                        <!-- Conductor -->
                        <label class="flex flex-col gap-1">
                            <span class="font-medium text-slate-600 text-[11px]">Conductor</span>
                            <select th:field="*{conductorId}"
                                    class="px-3 py-1.5 rounded-xl border border-slate-200 text-slate-700">
                                <option value="">Seleccione...</option>
                                <option th:each="c : ${conductores}"
                                        th:value="${c.id}"
                                        th:text="${c.nombreCompleto}">Conductor</option>
                            </select>
                        </label>

                        <!-- Turno -->
                        <label class="flex flex-col gap-1">
                            <span class="font-medium text-slate-600 text-[11px]">Turno</span>
                            <input type="text" th:field="*{turno}"
                                   placeholder="Ma√±ana / Tarde / Noche"
                                   class="px-3 py-1.5 rounded-xl border border-slate-200 text-slate-700" />
                        </label>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                        <!-- Hora inicio -->
                        <label class="flex flex-col gap-1">
                            <span class="font-medium text-slate-600 text-[11px]">Hora inicio programada</span>
                            <input type="time" th:field="*{horaInicioProgramada}"
                                   class="px-3 py-1.5 rounded-xl border border-slate-200 text-slate-700" />
                        </label>

                        <!-- Hora fin -->
                        <label class="flex flex-col gap-1">
                            <span class="font-medium text-slate-600 text-[11px]">Hora fin programada</span>
                            <input type="time" th:field="*{horaFinProgramada}"
                                   class="px-3 py-1.5 rounded-xl border border-slate-200 text-slate-700" />
                        </label>

                        <!-- C√≥digo p√∫blico -->
                        <label class="flex flex-col gap-1">
                            <span class="font-medium text-slate-600 text-[11px]">C√≥digo p√∫blico</span>
                            <input type="text" th:field="*{codigoPublico}"
                                   class="px-3 py-1.5 rounded-xl border border-slate-200 text-slate-700" />
                        </label>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
                        <!-- Origen -->
                        <label class="flex flex-col gap-1">
                            <span class="font-medium text-slate-600 text-[11px]">Origen</span>
                            <input type="text" th:field="*{origen}"
                                   class="px-3 py-1.5 rounded-xl border border-slate-200 text-slate-700" />
                        </label>

                        <!-- Destino -->
                        <label class="flex flex-col gap-1">
                            <span class="font-medium text-slate-600 text-[11px]">Destino</span>
                            <input type="text" th:field="*{destino}"
                                   class="px-3 py-1.5 rounded-xl border border-slate-200 text-slate-700" />
                        </label>
                    </div>

                    <!-- Observaciones -->
                    <label class="flex flex-col gap-1 text-xs">
                        <span class="font-medium text-slate-600 text-[11px]">Observaciones</span>
                        <textarea th:field="*{observaciones}"
                                  rows="2"
                                  class="px-3 py-1.5 rounded-xl border border-slate-200 text-slate-700 resize-y"></textarea>
                    </label>
                </section>

				<!-- Card: pasajeros -->
				<section class="bg-white rounded-2xl border border-slate-100 p-4 shadow-sm space-y-3">
				    <div class="flex items-center justify-between mb-1">
				        <div>
				            <h2 class="text-sm font-semibold text-slate-900">Pasajeros</h2>
				            <p class="text-xs text-slate-500">
				                Lista editable de pasajeros para este servicio (arrastrar para ordenar).
				            </p>
				        </div>
				        <button type="button"
				                class="px-3 py-1.5 rounded-full bg-slate-900 text-xs text-white hover:bg-slate-800"
				                onclick="agregarPasajeroRow()">
				            + Agregar pasajero
				        </button>
				    </div>

				    <div class="overflow-x-auto">
				        <table class="min-w-full text-xs">
				            <thead class="border-b border-slate-200 bg-slate-50">
				            <tr>
				                <th class="px-2 py-2 text-center font-semibold text-slate-600 w-10">Orden</th>
				                <th class="px-2 py-2 text-left font-semibold text-slate-600">Nombre</th>
				                <th class="px-2 py-2 text-left font-semibold text-slate-600">RUT</th>
								<th class="px-2 py-2 text-left font-semibold text-slate-600">Telefono contacto</th>
				                <th class="px-2 py-2 text-left font-semibold text-slate-600">Punto subida</th>
				                <th class="px-2 py-2 text-left font-semibold text-slate-600">Punto bajada</th>
				                <th class="px-2 py-2 text-left font-semibold text-slate-600">Observaciones</th>
				                <th class="px-2 py-2 text-center font-semibold text-slate-600">Eliminar</th>
				            </tr>
				            </thead>
				            <tbody id="bodyPasajeros">
				            <tr th:each="p, iter : *{pasajeros}">
				                <!-- id oculto + orden -->
				                <td class="px-2 py-1 text-center align-middle handle cursor-move">
				                    <span class="text-slate-400 text-lg select-none">‚ãÆ‚ãÆ</span>
				                    <input type="hidden"
				                           th:name="|pasajeros[${iter.index}].orden|"
				                           th:value="${iter.index}"
				                           class="orden-input" />
				                    <input type="hidden"
				                           th:field="*{pasajeros[__${iter.index}__].id}" />
				                </td>

				                <td class="px-2 py-1">
				                    <input type="text"
				                           th:field="*{pasajeros[__${iter.index}__].nombrePasajero}"
				                           class="w-full px-2 py-1 rounded-lg border border-slate-200" />
				                </td>
				                <td class="px-2 py-1">
				                    <input type="text"
				                           th:field="*{pasajeros[__${iter.index}__].rutPasajero}"
				                           class="w-full px-2 py-1 rounded-lg border border-slate-200" />
				                </td>
								<td class="px-2 py-1">
								    <input type="text"
								           th:field="*{pasajeros[__${iter.index}__].telefonoContacto}"
								           class="w-full px-2 py-1 rounded-lg border border-slate-200" />
								</td>

				                <td class="px-2 py-1">
				                    <input type="text"
				                           th:field="*{pasajeros[__${iter.index}__].puntoSubida}"
				                           class="w-full px-2 py-1 rounded-lg border border-slate-200" />
				                </td>
				                <td class="px-2 py-1">
				                    <input type="text"
				                           th:field="*{pasajeros[__${iter.index}__].puntoBajada}"
				                           class="w-full px-2 py-1 rounded-lg border border-slate-200" />
				                </td>
				                <td class="px-2 py-1">
				                    <input type="text"
				                           th:field="*{pasajeros[__${iter.index}__].observaciones}"
				                           class="w-full px-2 py-1 rounded-lg border border-slate-200" />
				                </td>

				                <!-- Checkbox eliminar (puede ir oculto si quieres) -->
				                <td class="px-2 py-1 text-center">
				                    <!-- checkbox real que viaja al backend -->
				                    <input type="checkbox"
				                           th:field="*{pasajeros[__${iter.index}__].eliminar}"
				                           class="w-4 h-4 rounded border-slate-300 hidden eliminar-checkbox" />

				                    <!-- bot√≥n visual -->
				                    <button type="button"
				                            class="text-[11px] text-red-500 hover:underline"
				                            onclick="eliminarPasajeroRow(this)">
				                        Eliminar
				                    </button>
				                </td>
				            </tr>
				            </tbody>
				        </table>
				    </div>
				    <p class="text-[11px] text-slate-400">
				        El bot√≥n "Eliminar" marca el pasajero para borrarlo al guardar.  
				        Puedes arrastrar por la columna ‚ÄúOrden‚Äù para reordenar.
				    </p>
				</section>

				<script>
				    // Marca el pasajero como eliminado y oculta la fila
				    function eliminarPasajeroRow(button) {
				        if (!confirm('¬øSeguro que deseas eliminar este pasajero?')) {
				            return;
				        }
				        const row = button.closest('tr');

				        // Busca el checkbox "eliminar" de esa fila y lo marca
				        const checkbox = row.querySelector('.eliminar-checkbox');
				        if (checkbox) {
				            checkbox.checked = true;
				        }

				        // Opcional: oculta visualmente la fila
				        row.style.display = 'none';
				    }
				</script>
                <!-- Card: historial del servicio -->
                <section class="bg-white rounded-2xl border border-slate-100 p-4 shadow-sm space-y-2">
                    <div class="flex items-center justify-between">
                        <h2 class="text-sm font-semibold text-slate-900">Historial del servicio</h2>
                        <span class="text-[11px] text-slate-400">Solo lectura</span>
                    </div>

                    <div th:if="${#lists.isEmpty(historial)}" class="text-xs text-slate-400">
                        Sin movimientos registrados.
                    </div>

                    <ul th:if="${!#lists.isEmpty(historial)}" class="space-y-2 text-xs">
                        <li th:each="h : ${historial}"
                            class="flex justify-between items-start border-b border-slate-100 pb-1">
                            <div>
                                <div class="font-medium text-slate-700"
                                     th:text="${h.descripcion}">Cambio de estado</div>
                                <div class="text-[11px] text-slate-400"
                                     th:text="${h.detalle}">Detalle</div>
                            </div>
                            <div class="text-right text-[11px] text-slate-400">
                                <div th:text="${h.fechaHora}">2025-01-01 10:00</div>
                                <div th:text="${h.usuario}">admin</div>
                            </div>
                        </li>
                    </ul>
                </section>

				<!-- Botones de acci√≥n -->
				<div class="flex flex-wrap gap-2 items-center mt-2">
				    <!-- Guardar -->
				    <button type="submit"
				            class="px-4 py-1.5 rounded-full bg-slate-900 text-xs text-white hover:bg-slate-800">
				        Guardar cambios
				    </button>

				    <!-- Eliminar servicio -->
				    <form th:action="@{/admin/servicios/{id}/eliminar(id=${id})}"
				          method="post"
				          onsubmit="return confirm('¬øSeguro que deseas eliminar este servicio? Esta acci√≥n no se puede deshacer.');">
				        <!-- CSRF -->
						<th:block th:if="${_csrf != null}">
						    <input type="hidden"
						           th:name="${_csrf.parameterName}"
						           th:value="${_csrf.token}" />
						</th:block>

				        <button type="submit"
				                class="px-4 py-1.5 rounded-full bg-rose-600 text-xs text-white hover:bg-rose-700">
				            Eliminar servicio
				        </button>
				    </form>
				</div>


            </form>
        </div>
    </main>
</div>

<script>
    // A√±o sidebar
    const today = new Date();
    const yearSidebar = document.getElementById("yearSpanSidebar");
    if (yearSidebar) yearSidebar.textContent = today.getFullYear();

    // Drag & drop de pasajeros
    function actualizarOrdenInputs() {
        const rows = document.querySelectorAll("#bodyPasajeros tr");
        rows.forEach((tr, idx) => {
            const ordenInput = tr.querySelector(".orden-input");
            if (ordenInput) ordenInput.value = idx;
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        const tbody = document.getElementById("bodyPasajeros");
        if (tbody && window.Sortable) {
            new Sortable(tbody, {
                handle: ".handle",
                animation: 150,
                onEnd: actualizarOrdenInputs
            });
            actualizarOrdenInputs();
        }

        const form = document.getElementById("formEditarServicio");
        if (form) {
            form.addEventListener("submit", function (e) {
                if (!validarPasajeros()) {
                    e.preventDefault();
                    return false;
                }
                actualizarOrdenInputs();
            });
        }
    });

    // Agregar fila de pasajero
    function agregarPasajeroRow() {
        const tbody = document.getElementById("bodyPasajeros");
        if (!tbody) return;

        const index = tbody.querySelectorAll("tr").length;

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="px-2 py-1 text-center align-middle handle cursor-move">
                <span class="text-slate-400 text-lg select-none">‚ãÆ‚ãÆ</span>
                <input type="hidden" name="pasajeros[${index}].orden" value="${index}" class="orden-input" />
                <input type="hidden" name="pasajeros[${index}].id" value="" />
            </td>
            <td class="px-2 py-1">
                <input type="text"
                       name="pasajeros[${index}].nombrePasajero"
                       class="w-full px-2 py-1 rounded-lg border border-slate-200" />
            </td>
            <td class="px-2 py-1">
                <input type="text"
                       name="pasajeros[${index}].rutPasajero"
                       class="w-full px-2 py-1 rounded-lg border border-slate-200" />
            </td>
			<td class="px-2 py-1">
			    <input type="text"
			           name="pasajeros[${index}].telefonoContacto"
			           class="w-full px-2 py-1 rounded-lg border border-slate-200" />
			</td>
			<td class="px-2 py-1">
                <input type="text"
                       name="pasajeros[${index}].puntoSubida"
                       class="w-full px-2 py-1 rounded-lg border border-slate-200" />
            </td>
            <td class="px-2 py-1">
                <input type="text"
                       name="pasajeros[${index}].puntoBajada"
                       class="w-full px-2 py-1 rounded-lg border border-slate-200" />
            </td>
            <td class="px-2 py-1">
                <input type="text"
                       name="pasajeros[${index}].observaciones"
                       class="w-full px-2 py-1 rounded-lg border border-slate-200" />
            </td>
            <td class="px-2 py-1 text-center">
                <input type="checkbox"
                       name="pasajeros[${index}].eliminar"
                       class="w-4 h-4 rounded border-slate-300" />
            </td>
        `;
        tbody.appendChild(tr);
        actualizarOrdenInputs();
    }

    // Validaci√≥n suave de pasajeros (nombre + RUT)
    function validarPasajeros() {
        const rows = document.querySelectorAll("#bodyPasajeros tr");
        let valido = true;
        let mensajes = [];

        // limpiar estilos anteriores
        document.querySelectorAll("#bodyPasajeros input").forEach(i => i.classList.remove("campo-error"));

        rows.forEach((tr, idx) => {
            const nombre = tr.querySelector('input[name^="pasajeros"][name$=".nombrePasajero"]');
            const rut = tr.querySelector('input[name^="pasajeros"][name$=".rutPasajero"]');
            const eliminar = tr.querySelector('input[name^="pasajeros"][name$=".eliminar"]');

            const nombreVal = nombre ? nombre.value.trim() : "";
            const rutVal = rut ? rut.value.trim() : "";
            const eliminarChecked = eliminar && eliminar.checked;

            // ¬øfila totalmente vac√≠a (y no marcada para eliminar)? -> la ignoramos
            const otrosText = tr.querySelectorAll('input[type="text"]');
            const algunoConDato = Array.from(otrosText).some(inp => inp.value.trim() !== "");

            if (!nombreVal && !rutVal && !algunoConDato && !eliminarChecked) {
                return; // skip
            }

            // Si hay algo en la fila (o marcada para eliminar) pero falta nombre o RUT, avisamos
            if (!eliminarChecked && (!nombreVal || !rutVal)) {
                valido = false;
                if (!nombreVal && nombre) nombre.classList.add("campo-error");
                if (!rutVal && rut) rut.classList.add("campo-error");
                mensajes.push(`Completa nombre y RUT del pasajero #${idx + 1}`);
            }
        });

        if (!valido) {
            alert(mensajes.join("\n"));
        }
        return valido;
    }
</script>

</body>
</html>
